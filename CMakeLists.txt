cmake_minimum_required (VERSION 3.0)

project (Betfair-Worker)

option(USE_STANDALONE_ASIO "set ON to use standalone Asio instead of Boost.Asio" OFF)
option(BUILD_TESTING "set ON to build library tests" OFF)
option(USE_OPENSSL "set OFF to build without OpenSSL" ON)

if(NOT MSVC)
    add_compile_options(-std=c++17 -Wall -Wextra)
    if (CMAKE_CXX_COMPILER_ID MATCHES "Clang")
        add_compile_options(-Wthread-safety)
    endif()
else()
    add_compile_options(/W1)
endif()

add_library(simple-web-server INTERFACE)

target_include_directories(simple-web-server INTERFACE ${CMAKE_CURRENT_SOURCE_DIR})

find_package(Threads REQUIRED)
target_link_libraries(simple-web-server INTERFACE ${CMAKE_THREAD_LIBS_INIT})

if(USE_STANDALONE_ASIO)
    target_compile_definitions(simple-web-server INTERFACE USE_STANDALONE_ASIO)
    find_path(ASIO_PATH asio.hpp)
    if(NOT ASIO_PATH)
        message(FATAL_ERROR "Standalone Asio not found")
    else()
        target_include_directories(simple-web-server INTERFACE ${ASIO_PATH})
    endif()
else()
    find_package(Boost 1.53.0 COMPONENTS system thread REQUIRED)
    target_link_libraries(simple-web-server INTERFACE ${Boost_LIBRARIES})
    target_include_directories(simple-web-server INTERFACE ${Boost_INCLUDE_DIR})
    if("${CMAKE_CXX_COMPILER_ID}" STREQUAL "GNU" AND CMAKE_CXX_COMPILER_VERSION VERSION_LESS 4.9)
        target_compile_definitions(simple-web-server INTERFACE USE_BOOST_REGEX)
        find_package(Boost 1.53.0 COMPONENTS regex REQUIRED)
        target_link_libraries(simple-web-server INTERFACE ${Boost_LIBRARIES})
        target_include_directories(simple-web-server INTERFACE ${Boost_INCLUDE_DIR})
    endif()
endif()
if(WIN32)
    target_link_libraries(simple-web-server INTERFACE ws2_32 wsock32)
endif()

if(APPLE)
    set(OPENSSL_ROOT_DIR "/usr/local/opt/openssl")
endif()
if(USE_OPENSSL)
    find_package(OpenSSL)
endif()
if(OPENSSL_FOUND)
    target_compile_definitions(simple-web-server INTERFACE HAVE_OPENSSL)
    target_link_libraries(simple-web-server INTERFACE ${OPENSSL_LIBRARIES})
    target_include_directories(simple-web-server INTERFACE ${OPENSSL_INCLUDE_DIR})
endif()

if("${CMAKE_SOURCE_DIR}" STREQUAL "${CMAKE_CURRENT_SOURCE_DIR}")
    find_package(Boost 1.53.0 COMPONENTS system thread filesystem)
    if(Boost_FOUND)
        if(OPENSSL_FOUND)
            add_executable(betfair_examples betfair_examples.cpp betfair_data/BetfairMarket.cpp betfair_data/BetfairMarket.h betfair_data/BetfairEventType.cpp betfair_data/BetfairEventType.h betfair_data/BetfairRace.cpp betfair_data/BetfairRace.h betfair_data/BetfairGroup.cpp betfair_data/BetfairGroup.h betfair_data/BetfairEvent.cpp betfair_data/BetfairEvent.h NavigationLoader.cpp NavigationLoader.h BetfairData.cpp BetfairData.h betfair_data/BetfairObject.cpp betfair_data/BetfairObject.h betting_type/MarketFilter.cpp betting_type/MarketFilter.h APILoader.cpp APILoader.h betting_type/MarketCatalogue.cpp betting_type/MarketCatalogue.h betting_type/MarketDescription.cpp betting_type/MarketDescription.h betting_type/MarketLineRangeInfo.cpp betting_type/MarketLineRangeInfo.h betting_type/PriceLadderDescription.cpp betting_type/PriceLadderDescription.h betting_type/RunnerCatalog.cpp betting_type/RunnerCatalog.h betting_type/EventType.cpp betting_type/EventType.h betting_type/Competition.cpp betting_type/Competition.h betting_type/Event.cpp betting_type/Event.h betting_type/Runner.cpp betting_type/Runner.h betting_type/Order.cpp betting_type/Order.h betting_type/Match.cpp betting_type/Match.h betting_type/StartingPrices.cpp betting_type/StartingPrices.h betting_type/PriceSize.cpp betting_type/PriceSize.h betting_type/ClearedOrderSummary.cpp betting_type/ClearedOrderSummary.h betting_type/ItemDescription.cpp betting_type/ItemDescription.h betting_type/RunnerId.cpp betting_type/RunnerId.h betting_type/CurrentOrderSummaryReport.cpp betting_type/CurrentOrderSummaryReport.h betting_type/CurrentOrderSummary.cpp betting_type/CurrentOrderSummary.h betting_type/ExchangePrices.cpp betting_type/ExchangePrices.h betting_type/EventResult.cpp betting_type/EventResult.h betting_type/CompetitionResult.cpp betting_type/CompetitionResult.h betting_type/EventTypeResult.cpp betting_type/EventTypeResult.h betting_type/MarketTypeResult.cpp betting_type/MarketTypeResult.h betting_type/CountryCodeResult.cpp betting_type/CountryCodeResult.h betting_type/PlaceExecutionReport.cpp betting_type/PlaceExecutionReport.h betting_type/PlaceInstructionReport.cpp betting_type/PlaceInstructionReport.h betting_type/PlaceInstruction.cpp betting_type/PlaceInstruction.h betting_type/LimitOrder.cpp betting_type/LimitOrder.h betting_type/LimitOnCloseOrder.cpp betting_type/LimitOnCloseOrder.h betting_type/MarketOnCloseOrder.cpp betting_type/MarketOnCloseOrder.h betting_type/MarketVersion.cpp betting_type/MarketVersion.h betting_type/PriceProjection.cpp betting_type/PriceProjection.h betting_type/ExBestOffersOverrides.cpp betting_type/ExBestOffersOverrides.h betting_type/MarketBook.cpp betting_type/MarketBook.h betting_type/KeyLineDescription.cpp betting_type/KeyLineDescription.h betting_type/KeyLineSelection.cpp betting_type/KeyLineSelection.h betting_type/TimeRange.cpp betting_type/TimeRange.h betting_type/CancelInstruction.cpp betting_type/CancelInstruction.h betting_type/CancelExecutionReport.cpp betting_type/CancelExecutionReport.h betting_type/CancelInstructionReport.cpp betting_type/CancelInstructionReport.h betting_type/UpdateInstruction.cpp betting_type/UpdateInstruction.h betting_type/UpdateExecutionReport.cpp betting_type/UpdateExecutionReport.h betting_type/UpdateInstructionReport.cpp betting_type/UpdateInstructionReport.h)
            target_link_libraries(betfair_examples simple-web-server)
            target_link_libraries(betfair_examples ${Boost_LIBRARIES})
            target_include_directories(betfair_examples PRIVATE ${Boost_INCLUDE_DIR})
        endif()
     endif()
    set(BUILD_TESTING ON)

    install(FILES 3rd-party/SimpleWeb/asio_compatibility.hpp 3rd-party/SimpleWeb/server_http.hpp 3rd-party/SimpleWeb/client_http.hpp 3rd-party/SimpleWeb/server_https.hpp 3rd-party/SimpleWeb/client_https.hpp 3rd-party/SimpleWeb/crypto.hpp 3rd-party/SimpleWeb/utility.hpp 3rd-party/SimpleWeb/status_code.hpp 3rd-party/SimpleWeb/mutex.hpp DESTINATION include/simple-web-server)
endif()

if(BUILD_TESTING)
    enable_testing()
    add_subdirectory(3rd-party/SimpleWeb/tests)
endif()

target_link_libraries(betfair_examples jsoncpp)